# Docker Deployment Guide

Deploy the WireGuard-compatible VPN server using Docker Compose.

## Prerequisites

- Docker Engine 20.10+
- Docker Compose v2.0+
- A server with a public IPv4 address
- UDP port 51820 open in firewall

## Quick Start

### 1. Clone and Configure

```bash
# On your remote server
cd /opt
git clone <your-repo> wireguard-vpn
cd wireguard-vpn

# Create environment file
cp .env.example .env

# Edit with your server's public IP
nano .env
# Set: VPN_PUBLIC_IP=YOUR_SERVER_IP
```

### 2. Create Configuration Directory

```bash
mkdir -p config
```

### 3. Build and Start

```bash
docker compose up -d --build
```

### 4. Get Server Public Key

```bash
# View server public key (needed for client configuration)
docker compose exec vpn-server cat /etc/wireguard/server_public.key
```

### 5. Add Peers

Edit `config/server.conf` to add client peers:

```bash
nano config/server.conf
```

Add peer sections:
```ini
[Peer]
PublicKey = <client-public-key>
AllowedIPs = 10.0.0.2/32
```

Restart to apply:
```bash
docker compose restart
```

## Configuration

### Server Configuration (`config/server.conf`)

```ini
[Interface]
PrivateKey = <auto-generated>
ListenPort = 51820
Address = 10.0.0.1/24, fd00:vpn::1/64

[Peer]
PublicKey = <client-1-public-key>
AllowedIPs = 10.0.0.2/32, fd00:vpn::2/128
# PersistentKeepalive = 25
```

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `VPN_PUBLIC_IP` | - | Server's public IPv4 address |
| `VPN_CONFIG` | `/etc/wireguard/server.conf` | Config file path |
| `VPN_INTERFACE` | `wg0` | TUN interface name |
| `VPN_SUBNET_V4` | `10.0.0.0/24` | IPv4 VPN subnet for NAT |
| `VPN_SUBNET_V6` | `fd00:vpn::/64` | IPv6 VPN subnet for NAT |
| `TZ` | `UTC` | Timezone |

## Client Configuration (macOS)

### Using WireGuard App

1. Install WireGuard from App Store
2. Create new tunnel with this config:

```ini
[Interface]
PrivateKey = <your-private-key>
Address = 10.0.0.2/32, fd00:vpn::2/128
DNS = 1.1.1.1

[Peer]
PublicKey = <server-public-key>
Endpoint = YOUR_SERVER_IP:51820
AllowedIPs = 0.0.0.0/0, ::/0
PersistentKeepalive = 25
```

### Generate Client Keys

On any machine with the VPN server or WireGuard tools:

```bash
# Using our tool
docker compose exec vpn-server wg-keygen keypair

# Or using wg command
wg genkey | tee privatekey | wg pubkey > publickey
```

## Operations

### View Logs

```bash
docker compose logs -f vpn-server
```

### Restart Server

```bash
docker compose restart
```

### Stop Server

```bash
docker compose down
```

### Update Server

```bash
git pull
docker compose up -d --build
```

### Check Status

```bash
docker compose ps
docker compose exec vpn-server pgrep vpn_server
```

## Firewall Configuration

### UFW (Ubuntu)

```bash
ufw allow 51820/udp
ufw allow 22/tcp  # SSH
ufw enable
```

### iptables

```bash
iptables -A INPUT -p udp --dport 51820 -j ACCEPT
```

### Digital Ocean

In the Digital Ocean control panel:
1. Go to Networking â†’ Firewalls
2. Create or edit firewall
3. Add inbound rule: UDP port 51820

## Troubleshooting

### Container Won't Start

Check logs:
```bash
docker compose logs vpn-server
```

Verify TUN device:
```bash
ls -la /dev/net/tun
```

### Clients Can't Connect

1. Verify firewall allows UDP 51820
2. Check server public key matches client config
3. Verify peer's public key in server config

### No Internet Through VPN

Check NAT rules inside container:
```bash
docker compose exec vpn-server iptables -t nat -L
```

Verify IP forwarding:
```bash
docker compose exec vpn-server cat /proc/sys/net/ipv4/ip_forward
```

## Security Notes

- Keep `config/` directory permissions restricted: `chmod 700 config`
- Never share private keys
- Use pre-shared keys for additional security
- Regularly rotate keys (recommended every 90 days)
